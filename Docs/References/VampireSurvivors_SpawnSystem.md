# Vampire Survivors - Spawn System Analysis

> **핵심 요약**
>
> Vampire Survivors는 **웨이브 + 시간 기반 하이브리드** 스폰 시스템을 사용합니다.
> - **정규 스폰**: 스폰 간격마다 계속 스폰 시도, 최소 적 수량 유지로 일정한 압박
> - **웨이브 전환**: 1분마다 새로운 웨이브로 전환, 스폰 가능한 적 타입 변경
> - **맵 이벤트**: 특정 시간에 1회성 특수 패턴 스폰 (확률 기반)
> - **성능 관리**: 300마리 상한선, 화면 밖 디스폰
> - **타임 리밋**: 15~30분 후 The Reaper 등장으로 게임 종료

## 핵심 메커니즘

### 1. 웨이브 시스템 (Wave System)

#### 기본 구조
- **웨이브 전환**: 1분마다 새로운 웨이브로 전환
- **정규 스폰**: 각 웨이브 내에서 스폰 간격마다 계속 스폰 시도
- **웨이브 구성 요소**:
  - 적 타입 목록 (Enemy Types): 해당 웨이브에서 스폰 가능한 적들
  - 최소 적 수량 (Minimum Amount): 화면에 유지되어야 할 최소 적 개체 수
  - 스폰 간격 (Spawn Interval): 적을 생성하는 주기 (예: 1초마다)

#### 적 타입 구성
- 각 웨이브는 **여러 적 타입**을 포함 (예: 좀비 + 박쥐 + 보스)
- 시간이 지날수록 새로운 적 타입이 **점진적으로 추가**됨
- 예시 (Mad Forest 기준):
  - 0-1분: 좀비, 작은 박쥐
  - 1분: + 글로잉 배트(보스)
  - 9분: + 거대 박쥐
  - 10분: + 늑대인간
  - 25분: + Venus(보스)

#### 스폰 로직

**분기 조건** (스폰 간격마다 실행):
- 현재 적 수 < 최소 수량 → ❓ **불명확** (할당량을 채울 때까지 스폰)
  - 가능성: 웨이브 적 풀에서 랜덤 선택
  - 가능성: 가중치 기반 선택
  - 가능성: 각 타입별 개별 할당량
- 현재 적 수 ≥ 최소 수량 → ✅ **명확**: 웨이브의 각 적 타입마다 1개씩 스폰

**핵심 특징**:
- 게임이 주기적으로 스폰을 **시도** (attempt)하는 방식
- 최소 수량 미달 시: 어떤 적을 선택하는지 공식 문서 없음
- 최소 수량 충족 시: 모든 타입 골고루 스폰 (밸런스 보장)
- **300마리 이상** 적이 있을 때는 정규 스폰 중단 (보스와 맵 이벤트만 가능)

### 2. 적 생성 및 제거 규칙

#### 스폰 위치
- 적들은 **화면 밖(off-screen)**에서 생성
- 플레이어가 보는 화면의 바깥 경계에서 등장

#### 디스폰 (Despawn)
- 플레이어가 적으로부터 **충분히 멀리 이동**하면 디스폰
- 메모리 및 성능 최적화를 위한 메커니즘
- 화면에서 벗어난 적은 자동으로 제거될 수 있음

#### 스폰 위치 분산

**Vampire Survivors의 확인된 정보**:

보스 스폰:
- 플레이어로부터 **특정 반경(diameter) 내에는 스폰 불가**
- 물리적으로 플레이어 바로 근처에 생성될 수 없도록 제한

일반 적 스폰:
- ❓ **불명확**: 구체적인 위치 분산 알고리즘은 공식 문서 없음
- 화면 밖 랜덤 스폰으로 추정되나 세부 메커니즘 미공개

맵 이벤트 특수 패턴:
- **스윕 (Sweep)**: 일직선으로 빠르게 지나가는 패턴 (예: Bat Swarm)
- **포위 (Encircle)**: 플레이어를 중심으로 원형 배치 (예: Flower Wall)
- 정규 스폰과 달리 **의도된 패턴**으로 배치되어 전술적 대응 요구

**일반적인 로그라이크 게임 개발 접근법**:

유사 장르 게임들이 스폰 집중(clustering)을 방지하기 위해 사용하는 방법:

1. **Inner/Outer Radius 시스템**
   - 플레이어로부터 최소 거리(Inner Radius, r)와 최대 거리(Outer Radius, R) 설정
   - r < 스폰 거리 < R 범위 내에서 위치 선택
   - 플레이어 바로 옆 스폰 방지 + 너무 먼 곳 스폰 방지

2. **공간 분할 (Space Partitioning)**
   - 플레이어 주변을 여러 구획(sector)으로 나눔 (예: 8방향)
   - 각 구획에 균등하게 또는 가중치에 따라 적 할당
   - 구획 내에서 랜덤 위치 선택
   - 한쪽 방향에 적이 몰리는 현상 방지

3. **중복 방지 체크 (Overlap Prevention)**
   - 스폰 위치 결정 후 주변에 다른 적이 있는지 체크
   - 일정 거리 이내에 적이 존재하면 다른 위치로 재시도
   - Sphere casting 또는 거리 계산으로 구현
   - 시도 횟수 제한으로 무한 루프 방지

4. **그리드 기반 스폰 포인트**
   - 화면 밖 경계를 따라 미리 정의된 다수의 스폰 포인트 배치
   - 각 스폰 시도마다 사용 가능한 포인트에서 랜덤 선택
   - 사용된 포인트는 쿨다운 적용하여 연속 스폰 방지
   - 예측 가능하고 균등한 분산 보장

**적용 시 고려사항**:
- 단순한 랜덤 스폰은 구현이 쉽지만 집중 현상 발생 가능
- Inner/Outer Radius만으로도 기본적인 분산 효과
- 공간 분할은 균등한 압박 제공, 특정 방향 방치 방지
- 중복 방지는 성능 비용이 있으므로 시도 횟수 제한 필요

### 3. 맵 이벤트 (Map Events)

#### 특징
- 정규 스폰 사이클과 **별개**로 동작하는 특수 스폰 이벤트
- 특정 시간에 **1회성**으로 트리거
- 매 플레이마다 같은 시간에 발생 → **예측 가능**
- 정규 웨이브와 **동시에** 발생 (추가 압박)

#### 구성 요소
- **트리거 시간**: 정확한 발생 시점 (분:초)
- **발생 확률**: 0-100% (확정 또는 랜덤)
- **반복 횟수**: 동일 이벤트 반복 가능
- **반복 간격**: 각 반복 사이의 시간 (초 단위)
- **특수 패턴**: 일직선 스윕, 원형 포위 등

#### Mad Forest 예시

**Bat Swarm** (50마리 박쥐가 일직선으로 스윕):
- 2분 0초: 100% 확률, 최대 2회
- 3분 0초: 10% 확률
- 7분 0초: 80% 확률, 최대 5회
- 20분 0초: 70% 확률, 최대 20회

**Flower Wall** (100개 꽃이 원형 포위):
- 5분 0초: 100% 확률, 30초 지속
- 10분 0초: 100% 확률, 60초 지속
- 25분 0초: 100% 확률, 10초 간격으로 5회 반복

#### 정규 웨이브와의 차이

| 요소 | 정규 웨이브 | 맵 이벤트 |
|------|------------|----------|
| **빈도** | 연속적 (스폰 간격마다) | 1회성 (특정 시간) |
| **목적** | 기본 압박 유지 | 긴장감 조성 |
| **예측성** | 높음 (매분 발생) | 중간 (확률 요소) |
| **패턴** | 화면 밖 랜덤 | 특수 패턴 (스윕, 포위 등) |

### 4. 시간 기반 요소

#### 스테이지 타임 리밋
- 각 스테이지는 소프트 타임 리밋 설정:
  - **15분** (짧은 스테이지)
  - **20분** (중간 길이 스테이지)
  - **30분** (긴 스테이지)

#### 타임 리밋 도달 시
1. 모든 적 제거 (화면 클리어)
2. 최종 보스 **The Reaper** 스폰
   - 압도적으로 강력한 적
   - 사실상 게임 종료를 강제하는 메커니즘

#### 시간 동기화
- 모든 시간 기반 이벤트는 **게임 내 타이머**를 기준으로 동작
- 적 스폰, 진화 상자 드롭, 웨이브 이벤트 모두 정확한 시간에 발생
- **허리 모드(Hurry Mode)**에서도 동일:
  - 시계 속도가 2배로 빨라지지만
  - 이벤트는 여전히 원래 타임스탬프에 발생

## 하이브리드 구조의 장점

| 요소 | 효과 |
|------|------|
| **일정한 난이도 곡선** | 1분마다 웨이브로 점진적 난이도 상승 |
| **예측성 + 긴장감** | 정규 웨이브는 예측 가능, 맵 이벤트로 서프라이즈 |
| **플레이어 성장 조화** | 초반(약한 적) → 중반(다양화) → 후반(압박) |
| **성능 최적화** | 화면 밖 디스폰 + 수량 관리 |

## 구현 시 고려사항

### 데이터 구조

**웨이브 데이터**:
- 발동 시간 (분)
- 적 타입 목록
- 최소 수량
- 스폰 간격

**맵 이벤트 데이터**:
- 트리거 시간 (분:초)
- 발생 확률 (0-100%)
- 반복 횟수 (최대 N회)
- 반복 간격 (초 단위)
- 적 그룹 구성 (타입, 수량)
- 스폰 패턴 (스윕, 포위, 랜덤 등)
- 지속 시간 (해당되는 경우)

### 스폰 매니저 동작 방식

**주기적 업데이트**:
1. **웨이브 전환**: 경과 시간이 1분 단위에 도달하면 다음 웨이브로 전환
2. **정규 스폰**: 스폰 간격(예: 1초)마다 현재 웨이브의 적 스폰 시도
3. **맵 이벤트**: 특정 시간에 도달하면 이벤트 트리거 체크
4. **타임 리밋**: 도달 시 모든 적 제거 후 The Reaper 스폰

**스폰 시도 로직** (스폰 간격마다 실행):
- **최소 수량 미달 시**: 할당량을 채울 때까지 연속 스폰
- **최소 수량 충족 시**: 웨이브의 각 적 타입당 1개씩만 스폰
- **300마리 이상 시**: 정규 스폰 중단 (보스/맵 이벤트만)

## 현재 프로젝트 적용 방안

### 1. 단계적 전환
- **Phase 1**: 기존 웨이브 시스템 유지하면서 자동 진행 추가
  - 웨이브를 수동에서 시간 기반 자동 진행으로 변경

- **Phase 2**: 스폰 로직 개선
  - 최소/최대 적 수량 관리 시스템 도입
  - 화면 밖 스폰 및 디스폰 구현

- **Phase 3**: 맵 이벤트 시스템
  - 특정 시간대 특수 스폰 이벤트 추가
  - 엘리트/보스 적 시간 기반 등장

### 2. 난이도 곡선 설계

| 시간대 | 단계 | 특징 |
|--------|------|------|
| 0-5분 | 튜토리얼 | 소수의 약한 적 |
| 5-10분 | 성장 | 적 타입 다양화 |
| 10-15분 | 도전 | 밀도 증가 |
| 15-20분 | 극한 | 특수 이벤트 빈번 |
| 20분+ | 서바이벌 | 압도적 물량 |

### 3. 기술적 구현 포인트

1. **타이머 시스템**: Time.deltaTime 누적으로 경과 시간 추적
2. **오브젝트 풀링**: 적 생성/제거 최적화
3. **데이터 기반 설정**: ScriptableObject로 웨이브/이벤트 데이터 관리
4. **화면 밖 스폰**: 적 생성 위치 및 디스폰 로직

## 유사 장르 게임 비교: 20 Minutes Till Dawn

### 스폰 시스템 구조

**20 Minutes Till Dawn**는 Session 기반 시스템을 사용:

| 파라미터 | 설명 |
|---------|------|
| **Session** | 특정 시간 범위에 활성화되는 스폰 단위 |
| **Start/End** | 세션 활성화 시간 (예: 11:20~11:25) |
| **Enemy Type** | 각 세션은 **단일 적 타입** 지정 |
| **Max** | 동시에 존재 가능한 최대 수 |
| **SpawnCD** | 스폰 시도 간격 (초) |
| **Num p/spawn** | 한 번에 스폰하는 수 |

**스폰 로직** (각 활성 세션마다 독립적으로):
```
SpawnCD 초마다:
  if (현재 해당 타입 적 수 < Max):
    Num p/spawn 만큼 스폰
```

**Forest 맵 예시** (14:00~12:00):
- Session A: Tentacle Monster (Max: 200, SpawnCD: 1초)
- Session B: Sploder (Max: 10, SpawnCD: 1초)
- Session C: Lurker (Max: ?, SpawnCD: ?)
- Session D: Elder (Max: ?, SpawnCD: ?)

→ 4가지 세션이 동시 활성화, 각각 독립적으로 스폰 시도

### Vampire Survivors와의 비교

| 요소 | Vampire Survivors | 20 Minutes Till Dawn |
|------|-------------------|----------------------|
| **시간 단위** | Wave (1분마다 전환) | Session (시간 범위) |
| **적 구성** | 웨이브당 **여러 타입** | 세션당 **단일 타입** |
| **수량 제어** | Minimum Amount | Max |
| **스폰 간격** | Spawn Interval | SpawnCD |
| **스폰 수** | ❓ 불명확 | Num p/spawn |
| **충족 시** | 각 타입 1개씩 | - |
| **미달 시** | ❓ 어떤 타입? | 해당 타입 |

### 핵심 차이점

**20MTD**:
- 각 세션은 **단일 적 타입**만 관리 (명확함)
- 시간 범위가 **겹치는 여러 세션**이 동시에 활성화
- 예: 14:00~12:00에 Tentacle, Sploder, Lurker, Elder 4가지 세션 동시 운영
- 각 세션이 독립적으로 자신의 Max 한도까지 스폰
- 어떤 적을 스폰할지 명확하고 구현이 단순

**Vampire Survivors**:
- 각 웨이브는 여러 적 타입 포함
- 최소 수량 미달 시 **어떤 타입을 선택하는지 불명확** ⚠️
  - 가능성 1: 균등 랜덤 선택
  - 가능성 2: 가중치 기반 랜덤
  - 가능성 3: 각 타입별 개별 할당량
- 최소 수량 충족 시는 명확 (각 타입 1개씩)

## 핵심 인사이트

Vampire Survivors의 스폰 시스템이 효과적인 이유:

1. **이중 레이어 시스템**
   - 정규 웨이브: 일정한 기본 압박
   - 맵 이벤트: 예측 불가능한 긴장감

2. **점진적 난이도 상승**
   - 시간에 따라 새로운 적 타입 해금
   - 웨이브마다 적 종류가 누적되어 다양성 증가

3. **최소 수량 시스템**
   - 플레이어가 적을 너무 빨리 처치해도 압박 유지
   - 300마리 상한선으로 성능 문제 방지

4. **확률 기반 이벤트**
   - 매 플레이마다 약간씩 다른 경험
   - 100% 확정 이벤트 + 확률 이벤트 혼합

### 현재 프로젝트 적용 방안

기존 웨이브 시스템을 제거하는 것이 아니라 **시간에 따라 자동으로 진행되는 웨이브 + 특수 이벤트**로 전환하는 것이 핵심입니다.

**선택 가능한 접근 방식**:
1. **Vampire Survivors 방식**: 웨이브당 여러 적 타입, 복잡한 스폰 로직
2. **20MTD 방식**: 세션당 단일 적 타입, 단순하지만 여러 세션 동시 운영
3. **하이브리드**: 각 웨이브 내에서 적 타입별로 개별 할당량 관리

## 관련 구현 파일

향후 구현 시 참고할 파일:
- `EnemySpawnManager.cs` - 스폰 매니저
- `WaveData.cs` - 웨이브 데이터 ScriptableObject
- `MapEventData.cs` - 맵 이벤트 데이터
- `GameTimer.cs` - 게임 경과 시간 관리

## 참고 자료

### Vampire Survivors
- [Vampire Survivors Wiki - Timed Enemy Spawn](https://vampire-survivors.fandom.com/wiki/Timed_Enemy_Spawn)
- [Vampire Survivors Wiki - Stages](https://vampire-survivors.fandom.com/wiki/Stages)
- [Vampire Survivors Wiki - Enemies](https://vampire-survivors.fandom.com/wiki/Enemies)
- [Vampire Survivors Wiki - Mad Forest](https://vampire.survivors.wiki/w/Mad_Forest)
- [Vampire Survivors Wiki - Map Events](https://vampire.survivors.wiki/w/Template:Map_event)

### 유사 장르 게임
- [20 Minutes Till Dawn - Enemies](https://20minutestilldawn.wiki.gg/wiki/Enemies)
- [20 Minutes Till Dawn - Spawner](https://20-minutes-till-dawn.fandom.com/wiki/Spawner)
- [Brotato - Enemies](https://brotato.wiki.spellsandguns.com/Enemies)

### 스폰 위치 분산 메커니즘
- [Boss spawn distance - Steam Discussion](https://steamcommunity.com/app/1794680/discussions/0/3194744685908432743/)
- [Enemy Spawning Algorithm - GameDev.net](https://gamedev.net/forums/topic/564630-enemy-spawning-algorithm/564630/)
- [Mission Generation Using ML - HackerNoon](https://hackernoon.com/mission-generation-using-classic-machine-learning-and-recurrent-neural-networks-in-zombie-state)
